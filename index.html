<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ˜Ÿæ¾œæ™ºèƒ½æ•°å­—äººé—®ç­”ç³»ç»Ÿ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{
      --primary-color:#00ffff;
      --secondary-color:#0080ff;
      --bg-dark:#0a0e27;
      --bg-medium:#1a1a2e;
      --bg-light:#16213e;
      --text-primary:#ffffff;
      --text-secondary:#66d9ff;
      --border-color:rgba(0,255,255,0.2);
      --glass-bg:rgba(255,255,255,0.05);
      --danger:#ff6b6b;
      --success:#00ff88;
      --warn:#ffd166;
      /* æ–°å¢ï¼šæŒ‰é’®é€æ˜åº¦å˜é‡ï¼Œå¯è‡ªå®šä¹‰è°ƒæ•´ */
      --login-btn-opacity: 0.9;
    }
    body.light-theme{
      --primary-color:#0080ff;
      --secondary-color:#00bfff;
      --bg-dark:#f0f4f8;
      --bg-medium:#ffffff;
      --bg-light:#e8eef5;
      --text-primary:#1a1a2e;
      --text-secondary:#4a5568;
      --border-color:rgba(0,128,255,0.2);
      --glass-bg:rgba(255,255,255,0.9);
    }
    body.purple-theme{
      --primary-color:#a855f7;
      --secondary-color:#ec4899;
      --bg-dark:#1e1b4b;
      --bg-medium:#2e1065;
      --bg-light:#4c1d95;
      --text-primary:#ffffff;
      --text-secondary:#c4b5fd;
      --border-color:rgba(168,85,247,0.3);
      --glass-bg:rgba(139,92,246,0.1);
    }
    body{
      font-family:'Microsoft YaHei','Segoe UI',Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg-dark) 0%,var(--bg-medium) 50%,var(--bg-light) 100%);
      min-height:100vh;
      overflow-x:hidden;
      position:relative;
      color:var(--text-primary);
      transition:all .3s ease;
    }
    body::before{
      content:'';
      position:fixed;top:0;left:0;width:100%;height:100%;
      background-image:
        linear-gradient(rgba(0,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,255,0.03) 1px, transparent 1px);
      background-size:50px 50px;
      pointer-events:none;
      z-index:0;
    }
    .particles{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}
    .particle{position:absolute;background:var(--primary-color);border-radius:50%;opacity:.5;animation:float 15s infinite;}
    @keyframes float{
      0%,100%{transform:translateY(0) translateX(0);opacity:0;}
      10%{opacity:.6;}
      90%{opacity:.6;}
      100%{transform:translateY(-100vh) translateX(50px);opacity:0;}
    }
    .scan-line{
      position:fixed;top:0;left:0;width:100%;height:2px;
      background:linear-gradient(90deg,transparent,var(--primary-color),transparent);
      opacity:.3;animation:scan 4s linear infinite;pointer-events:none;z-index:0;
    }
    @keyframes scan{0%{transform:translateY(0);}100%{transform:translateY(100vh);} }
    /* ========== é‡ç‚¹ç¾åŒ–ï¼šç™»å½•å®¹å™¨ï¼ˆè‡ªå®šä¹‰èƒŒæ™¯å›¾+å¸ƒå±€ä¼˜åŒ–ï¼‰ ========== */
    .login-container{
      position:fixed;top:0;left:0;width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      z-index:9999;
      /* 1. è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡ï¼šæ›¿æ¢urlå†…çš„åœ°å€ä¸ºä½ çš„å›¾ç‰‡è·¯å¾„ï¼ˆæœ¬åœ°/ç½‘ç»œå›¾ç‰‡å‡å¯ï¼‰ */
      background: url("register-bg.jpg") no-repeat center center fixed;
      background-size: cover;
      /* èƒŒæ™¯å åŠ æ¸å˜ï¼Œæå‡æ–‡å­—å¯è¯»æ€§ */
      background-blend-mode: overlay;
      background-color: rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease-out;
    }
    /* ç™»å½•å®¹å™¨è£…é¥°å›¾æ¡ˆï¼šæ–°å¢è§’è½å‡ ä½•è£…é¥° */
    .login-container::before,
    .login-container::after{
      content: '';
      position: absolute;
      width: 200px;
      height: 200px;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      z-index: 1;
      opacity: 0.5;
      animation: rotateSlow 20s linear infinite;
    }
    .login-container::before{
      top: 50px;
      left: 50px;
      border-top-color: var(--primary-color);
      border-right-color: var(--primary-color);
    }
    .login-container::after{
      bottom: 50px;
      right: 50px;
      border-bottom-color: var(--primary-color);
      border-left-color: var(--primary-color);
    }
    @keyframes rotateSlow{
      0%{transform: rotate(0deg);}
      100%{transform: rotate(360deg);}
    }
    /* ç™»å½•ç›’å­ï¼šä¼˜åŒ–å†…è¾¹è·ã€é˜´å½±ã€åœ†è§’ï¼Œå¢åŠ å†…éƒ¨è£…é¥° */
    .login-box{
      background:var(--glass-bg);
      backdrop-filter:blur(20px);
      border:2px solid var(--border-color);
      border-radius:30px;
      padding: 60px 45px; /* ä¼˜åŒ–å†…è¾¹è·ï¼Œæ›´èˆ’å±• */
      width:480px; /* å¾®è°ƒå®½åº¦ï¼Œæ›´åè°ƒ */
      max-width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,.5), 0 0 100px rgba(0,255,255,.1);
      animation:slideUp .5s ease-out;
      position:relative;
      overflow:hidden;
      z-index: 2; /* é«˜äºè£…é¥°å›¾æ¡ˆ */
    }
    .login-box::before{
      content:'';
      position:absolute;top:-50%;left:-50%;
      width:200%;height:200%;
      background:linear-gradient(45deg,transparent,rgba(0,255,255,0.05),transparent);
      animation:rotate 6s linear infinite;
    }
    @keyframes rotate{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    @keyframes slideUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);} }
    /* ç™»å½•logoå®¹å™¨ï¼šä¼˜åŒ–é—´è· */
    .logo-container{text-align:center;margin-bottom:45px;position:relative;z-index:1;}
    .logo{
      width:120px;height:120px;margin:0 auto 20px;
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      border-radius:30px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow:0 10px 30px rgba(0,255,255,.3), 0 0 60px rgba(0,255,255,.2);
      position:relative;overflow:hidden;
    }
    .logo::before{
      content:'';
      position:absolute;width:200%;height:200%;
      background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent);
      animation:shine 3s infinite;
    }
    @keyframes shine{
      0%{transform:translateX(-100%) translateY(-100%) rotate(45deg);}
      100%{transform:translateX(100%) translateY(100%) rotate(45deg);}
    }
    .logo-text{font-size:28px;font-weight:bold;color:white;z-index:1;text-shadow:0 2px 10px rgba(0,0,0,.3);letter-spacing:2px;}
    .logo-subtext{font-size:10px;letter-spacing:4px;color:white;opacity:.9;z-index:1;margin-top:5px;}
    .login-title{font-size:28px;color:var(--primary-color);text-align:center;margin-bottom:10px;font-weight:bold;position:relative;z-index:1;text-shadow:0 0 20px rgba(0,255,255,.5);}
    .login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:35px;font-size:14px;position:relative;z-index:1;}
    .form-group{margin-bottom:25px;position:relative;z-index:1;}
    .form-group label{display:block;color:var(--text-secondary);margin-bottom:8px;font-size:14px;}
    .form-group input{
      width:100%;padding:14px 20px;background:var(--glass-bg);
      border:1px solid var(--border-color);border-radius:15px;
      color:var(--text-primary);font-size:14px;transition:all .3s;
    }
    .form-group input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 20px rgba(0,255,255,.3);}
    /* 2. ç™»å½•æŒ‰é’®ï¼šè°ƒæ•´é€æ˜åº¦ï¼ˆå¯é€šè¿‡var(--login-btn-opacity)è‡ªå®šä¹‰ï¼‰+ ä¼˜åŒ–æ ·å¼ */
    .login-btn{
      width:100%;padding:16px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      border:none;border-radius:15px;color:white;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s;
      margin-top:20px;position:relative;z-index:1;box-shadow:0 5px 20px rgba(0,255,255,.3);
      opacity: var(--login-btn-opacity); /* åº”ç”¨é€æ˜åº¦ */
    }
    .login-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(0,255,255,.5);
      opacity: 1; /* hoveræ—¶é€æ˜åº¦å˜ä¸º1ï¼Œæ›´é†’ç›® */
    }
    .login-footer{text-align:center;margin-top:25px;color:var(--text-secondary);font-size:12px;position:relative;z-index:1;}
    .app-container{display:none;height:100vh;position:relative;z-index:1;}
    .app-container.active{display:flex;}
    .sidebar{
      width:280px;background:var(--glass-bg);backdrop-filter:blur(20px);
      border-right:1px solid var(--border-color);display:flex;flex-direction:column;
      transition:all .3s;box-shadow:5px 0 20px rgba(0,0,0,.2);
    }
    .sidebar-header{
      padding:20px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;gap:15px;position:relative;
    }
    .sidebar-header::after{
      content:'';position:absolute;bottom:0;left:0;width:100%;height:1px;
      background:linear-gradient(90deg,transparent,var(--primary-color),transparent);
    }
    .sidebar-logo{
      width:50px;height:50px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:14px;font-weight:bold;color:white;box-shadow:0 5px 15px rgba(0,255,255,.3);
    }
    .sidebar-logo-subtext{font-size:6px;letter-spacing:2px;margin-top:2px;}
    .sidebar-title{flex:1;}
    .sidebar-title h2{font-size:16px;color:var(--primary-color);margin-bottom:2px;}
    .sidebar-title p{font-size:11px;color:var(--text-secondary);}
    .new-chat-btn{
      margin:20px;padding:14px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      border:none;border-radius:12px;color:white;font-size:14px;font-weight:bold;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;transition:all .3s;
      box-shadow:0 5px 15px rgba(0,255,255,.3);
    }
    .new-chat-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,255,255,.5);}
    .sidebar-nav{flex:1;overflow-y:auto;padding:10px;}
    .sidebar-nav::-webkit-scrollbar{width:6px;}
    .sidebar-nav::-webkit-scrollbar-track{background:transparent;}
    .sidebar-nav::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px;}
    .nav-section{margin-bottom:20px;}
    .nav-section-title{
      padding:10px 15px;color:var(--text-secondary);
      font-size:12px;font-weight:bold;text-transform:uppercase;letter-spacing:1px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .nav-tools{display:flex;gap:8px;}
    .tiny-btn{
      padding:6px 10px;border-radius:10px;border:1px solid var(--border-color);
      background:var(--glass-bg);color:var(--text-secondary);cursor:pointer;font-size:12px;
      transition:all .25s;
    }
    .tiny-btn:hover{border-color:var(--primary-color);color:var(--primary-color);transform:translateY(-1px);}
    .nav-item{
      padding:12px 15px;margin:5px 0;background:var(--glass-bg);
      border:1px solid transparent;border-radius:10px;cursor:pointer;transition:all .3s;
      display:flex;align-items:center;gap:10px;color:var(--text-secondary);
    }
    .nav-item:hover{
      background:var(--border-color);border-color:var(--primary-color);
      color:var(--primary-color);transform:translateX(5px);
    }
    .nav-item.active{background:var(--border-color);border-color:var(--primary-color);color:var(--primary-color);}
    .nav-item-icon{font-size:18px;}
    .nav-item-content{flex:1;min-width:0;}
    .nav-item-title{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .nav-item-time{font-size:11px;opacity:.7;}
    .sidebar-footer{padding:20px;border-top:1px solid var(--border-color);}
    .user-info{
      display:flex;align-items:center;gap:12px;padding:12px;background:var(--glass-bg);
      border-radius:12px;cursor:pointer;transition:all .3s;
    }
    .user-info:hover{background:var(--border-color);}
    .user-avatar{
      width:40px;height:40px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      display:flex;align-items:center;justify-content:center;font-size:18px;
      box-shadow:0 3px 10px rgba(0,255,255,.3);
    }
    .user-details{flex:1;}
    .user-name{font-size:14px;font-weight:bold;color:var(--text-primary);}
    .user-status{font-size:11px;color:var(--text-secondary);}
    /* æ–°å¢ï¼šé€€å‡ºæŒ‰é’®æ ·å¼ */
    .logout-btn {
      width: 100%;
      margin-top: 15px;
      padding: 10px;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--danger);
      font-size: 13px;
      cursor: pointer;
      transition: all .3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .logout-btn:hover {
      border-color: var(--danger);
      background: rgba(255, 107, 107, 0.1);
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
    }
    .main-content{flex:1;display:flex;flex-direction:column;position:relative;}
    .toolbar{
      padding:20px 30px;background:var(--glass-bg);backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;justify-content:space-between;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .toolbar-left{display:flex;align-items:center;gap:20px;}
    .toolbar-title{font-size:18px;font-weight:bold;color:var(--primary-color);text-shadow:0 0 10px rgba(0,255,255,.5);}
    .ai-status{
      display:flex;align-items:center;gap:8px;padding:8px 16px;
      background:var(--glass-bg);border:1px solid var(--border-color);
      border-radius:20px;font-size:13px;color:var(--text-secondary);
    }
    .ai-status-dot{
      width:8px;height:8px;border-radius:50%;
      background:#00ff00;box-shadow:0 0 10px #00ff00;animation:blink 2s infinite;
    }
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
    .toolbar-right{display:flex;gap:10px;align-items:center;}
    .icon-btn{
      width:40px;height:40px;background:var(--glass-bg);
      border:1px solid var(--border-color);border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:all .3s;font-size:18px;
    }
    .icon-btn:hover{
      background:var(--border-color);border-color:var(--primary-color);
      color:var(--primary-color);transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(0,255,255,.3);
    }
    .chat-area{
      flex:1;overflow-y:auto;padding:30px;display:flex;
      flex-direction:column;gap:20px;
    }
    .chat-area::-webkit-scrollbar{width:8px;}
    .chat-area::-webkit-scrollbar-track{background:var(--glass-bg);border-radius:10px;}
    .chat-area::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:10px;}
    .message{display:flex;gap:15px;animation:messageSlide .3s ease-out;}
    @keyframes messageSlide{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);} }
    .message.user{flex-direction:row-reverse;}
    .message-avatar{
      width:45px;height:45px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:22px;flex-shrink:0;
      box-shadow:0 5px 15px rgba(0,0,0,.3);
    }
    .message.user .message-avatar{background:linear-gradient(135deg,#667eea,#764ba2);}
    .message.ai .message-avatar{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));}
    .message.error .message-avatar{background:linear-gradient(135deg,#ff6b6b,#ee5a6f);}
    .message-content-wrapper{max-width:70%;}
    .message.user .message-content-wrapper{display:flex;flex-direction:column;align-items:flex-end;}
    .message-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
    .message.user .message-header{flex-direction:row-reverse;}
    .message-sender{font-size:14px;font-weight:bold;color:var(--text-primary);}
    .message-time{font-size:12px;color:var(--text-secondary);opacity:.7;}
    .message-content{
      padding:16px 20px;border-radius:18px;line-height:1.6;font-size:14px;
      word-wrap:break-word;white-space:pre-wrap;position:relative;
    }
    .message.user .message-content{
      background:linear-gradient(135deg,#667eea,#764ba2);color:white;
      border-bottom-right-radius:5px;box-shadow:0 5px 15px rgba(102,126,234,.3);
    }
    .message.ai .message-content{
      background:var(--glass-bg);border:1px solid var(--border-color);
      color:var(--text-primary);border-bottom-left-radius:5px;
    }
    .message.error .message-content{
      background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.3);
      color:#ffcccc;border-bottom-left-radius:5px;
    }
    .msg-actions{
      margin-top:8px;display:flex;gap:8px;opacity:.85;
      justify-content:flex-end;
    }
    .msg-btn{
      padding:6px 10px;font-size:12px;border-radius:10px;
      border:1px solid var(--border-color);background:var(--glass-bg);
      color:var(--text-secondary);cursor:pointer;transition:all .2s;
      user-select:none;
    }
    .msg-btn:hover{border-color:var(--primary-color);color:var(--primary-color);transform:translateY(-1px);}
    .msg-btn.danger:hover{border-color:var(--danger);color:var(--danger);}
    .msg-btn.success:hover{border-color:var(--success);color:var(--success);}
    .input-area{
      padding:20px 30px;background:var(--glass-bg);backdrop-filter:blur(20px);
      border-top:1px solid var(--border-color);box-shadow:0 -2px 10px rgba(0,0,0,.1);
    }
    .quick-prompts{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
    .quick-prompt{
      padding:8px 16px;background:var(--glass-bg);border:1px solid var(--border-color);
      border-radius:20px;color:var(--text-secondary);font-size:13px;cursor:pointer;transition:all .3s;
    }
    .quick-prompt:hover{
      background:var(--border-color);border-color:var(--primary-color);color:var(--primary-color);
      transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,255,255,.2);
    }
    .input-wrapper{display:flex;gap:15px;align-items:flex-end;}
    .input-container{flex:1;position:relative;}
    #messageInput{
      width:100%;padding:16px 20px;background:var(--glass-bg);
      border:2px solid var(--border-color);border-radius:20px;
      color:var(--text-primary);font-size:14px;resize:none;max-height:150px;font-family:inherit;
    }
    #messageInput:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 25px rgba(0,255,255,.3);}
    #sendBtn{
      padding:16px 32px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      border:none;border-radius:20px;color:white;font-size:14px;font-weight:bold;cursor:pointer;
      transition:all .3s;white-space:nowrap;box-shadow:0 5px 15px rgba(0,255,255,.3);
    }
    #sendBtn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,255,255,.5);}
    #sendBtn:disabled{opacity:.5;cursor:not-allowed;}
    .notification{
      position:fixed;top:20px;right:20px;padding:16px 24px;
      background:var(--glass-bg);backdrop-filter:blur(20px);
      border:1px solid var(--border-color);border-radius:12px;color:var(--text-primary);
      box-shadow:0 10px 30px rgba(0,0,0,.3);
      z-index:10000;animation:slideIn .3s ease-out;display:none;
      max-width:520px;
    }
    .notification.show{display:block;}
    .notification.success{border-color:#00ff00;box-shadow:0 10px 30px rgba(0,255,0,.3);}
    .notification.error{border-color:var(--danger);box-shadow:0 10px 30px rgba(255,107,107,.3);}
    @keyframes slideIn{from{opacity:0;transform:translateX(100px);}to{opacity:1;transform:translateX(0);} }
    .modal-mask{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      z-index:2000;display:none;align-items:center;justify-content:center;
      padding:20px;
    }
    .modal-mask.show{display:flex;}
    .modal{
      width:720px;max-width:95%;
      background:var(--bg-medium);border:1px solid var(--border-color);
      border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal-header{
      padding:16px 18px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;justify-content:space-between;
    }
    .modal-title{font-weight:bold;color:var(--primary-color);}
    .modal-close{
      width:34px;height:34px;border-radius:10px;border:1px solid var(--border-color);
      background:var(--glass-bg);cursor:pointer;display:flex;align-items:center;justify-content:center;
    }
    .modal-close:hover{border-color:var(--primary-color);color:var(--primary-color);}
    .modal-body{padding:16px 18px;color:var(--text-secondary);}
    .modal-row{display:flex;gap:10px;align-items:center;margin:10px 0;}
    .modal-row input,.modal-row select{
      flex:1;padding:10px 12px;border-radius:12px;border:1px solid var(--border-color);
      background:var(--glass-bg);color:var(--text-primary);
    }
    .modal-row button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border-color);
      background:var(--glass-bg);color:var(--text-secondary);cursor:pointer;
    }
    .modal-row button:hover{border-color:var(--primary-color);color:var(--primary-color);}
    .modal-list{
      margin-top:12px;border:1px solid var(--border-color);border-radius:12px;
      max-height:360px;overflow:auto;
    }
    .modal-item{
      padding:10px 12px;border-bottom:1px solid var(--border-color);
      display:flex;gap:10px;align-items:flex-start;
    }
    .modal-item:last-child{border-bottom:none;}
    .tag{
      padding:4px 8px;border-radius:999px;border:1px solid var(--border-color);
      font-size:12px;color:var(--text-secondary);
      white-space:nowrap;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    @media (max-width:968px){
      .sidebar{position:fixed;left:-280px;height:100%;z-index:999;}
      .sidebar.active{left:0;}
      .toolbar-left{flex-direction:column;align-items:flex-start;gap:10px;}
      .message-content-wrapper{max-width:85%;}
      .quick-prompts{overflow-x:auto;flex-wrap:nowrap;}
      /* ç§»åŠ¨ç«¯é€‚é…ç™»å½•å®¹å™¨è£…é¥° */
      .login-container::before,
      .login-container::after{
        width: 120px;
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>
  <div class="scan-line" id="scanLine"></div>
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="logo-container">
        <div class="logo">
          <div class="logo-text">æ˜Ÿæ¾œ</div>
          <div class="logo-subtext">XINGLAN AI</div>
        </div>
      </div>
      <h1 class="login-title">ç³»ç»ŸéªŒè¯</h1>
      <p class="login-subtitle">è¯·è¾“å…¥ç™»å½•å¯†é’¥ä»¥è®¿é—®æ˜Ÿæ¾œæ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="accessKey">ğŸ”‘ ç™»å½•å¯†é’¥</label>
          <input type="password" id="accessKey" placeholder="è¯·è¾“å…¥å¯†é’¥" required>
        </div>
        <button type="submit" class="login-btn">éªŒè¯å¹¶ç™»å½•</button>
      </form>
      <div class="login-footer">Â© 2025 æ˜Ÿæ¾œæ™ºèƒ½ç§‘æŠ€ ç‰ˆæƒæ‰€æœ‰</div>
    </div>
  </div>
  <div class="app-container" id="appContainer">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div>æ˜Ÿæ¾œ</div>
          <div class="sidebar-logo-subtext">XINGLAN</div>
        </div>
        <div class="sidebar-title">
          <h2>æ™ºèƒ½é—®ç­”</h2>
          <p>AIåŠ©æ‰‹</p>
        </div>
      </div>
      <button class="new-chat-btn" id="newChatBtn">
        <span>â•</span><span>æ–°å»ºå¯¹è¯</span>
      </button>
      <div class="sidebar-nav" id="sidebarNav">
        <div class="nav-section">
          <div class="nav-section-title">
            <span>æœ€è¿‘å¯¹è¯</span>
            <span class="nav-tools">
              <button class="tiny-btn" id="openSearchBtn" title="æœç´¢å¯¹è¯/æ¶ˆæ¯">ğŸ”</button>
              <button class="tiny-btn" id="openStarredBtn" title="æ”¶è—å¤¹">â­</button>
            </span>
          </div>
          <div class="nav-item active" id="navDefaultItem">
            <span class="nav-item-icon">ğŸ’¬</span>
            <div class="nav-item-content">
              <div class="nav-item-title" id="conversationTitle">æ–°å¯¹è¯</div>
              <div class="nav-item-time" id="conversationTime">åˆšåˆš</div>
            </div>
          </div>
        </div>
      </div>
      <div class="sidebar-footer">
        <div class="user-info" id="userInfo">
          <div class="user-avatar">ğŸ”</div>
          <div class="user-details">
            <div class="user-name" id="userName">å·²è®¤è¯ç”¨æˆ·</div>
            <div class="user-status">åœ¨çº¿</div>
          </div>
        </div>
        <!-- æ–°å¢ï¼šé€€å‡ºç™»å½•æŒ‰é’® -->
        <button id="logoutBtn" class="logout-btn">ğŸšª é€€å‡ºç™»å½•</button>
      </div>
    </div>
    <div class="main-content">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="toolbar-title" id="toolbarTitle">æ˜Ÿæ¾œæ™ºèƒ½åŠ©æ‰‹</div>
          <div class="ai-status">
            <span class="ai-status-dot"></span>
            <span id="aiReadyText">æ˜Ÿæ¾œAI å·²å°±ç»ª</span>
          </div>
        </div>
        <div class="toolbar-right">
          <div class="icon-btn" id="exportBtn" title="å¯¼å‡ºå¯¹è¯">ğŸ“¤</div>
          <div class="icon-btn" id="maskBtn" title="æ•æ„Ÿä¿¡æ¯é®ç½©">ğŸ•¶ï¸</div>
          <div class="icon-btn" id="clearBtn" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</div>
          <div class="icon-btn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</div>
        </div>
      </div>
      <div class="chat-area" id="chatArea">
        <div class="welcome-screen" id="welcomeScreen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px;">
          <div style="font-size:80px;margin-bottom:30px;filter:drop-shadow(0 0 20px rgba(0,255,255,.5));">ğŸ¤–</div>
          <h1 style="font-size:32px;color:var(--primary-color);margin-bottom:15px;font-weight:bold;text-shadow:0 0 20px rgba(0,255,255,.5);">
            æ‚¨å¥½ï¼æˆ‘æ˜¯æ˜Ÿæ¾œæ™ºèƒ½åŠ©æ‰‹
          </h1>
          <p style="font-size:16px;color:var(--text-secondary);margin-bottom:40px;max-width:600px;line-height:1.6;">
            åŸºäºå¤§æ¨¡å‹èƒ½åŠ›ï¼Œä¸ºæ‚¨æä¾›æ™ºèƒ½ã€é«˜æ•ˆã€ä¸“ä¸šçš„é—®ç­”æœåŠ¡ã€‚<br>
            è¾“å…¥é—®é¢˜ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤ï¼š<span class="mono">/help</span> æŸ¥çœ‹æ›´å¤šç©æ³•ã€‚
          </p>
        </div>
      </div>
      <div class="input-area">
        <div class="quick-prompts">
          <div class="quick-prompt">ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</div>
          <div class="quick-prompt">ä½ èƒ½å¸®æˆ‘åšä»€ä¹ˆï¼Ÿ</div>
          <div class="quick-prompt">è®²ä¸ªæœ‰è¶£çš„æ•…äº‹</div>
          <div class="quick-prompt">å†™ä¸€é¦–è¯—</div>
          <div class="quick-prompt">/faq</div>
          <div class="quick-prompt">/help</div>
        </div>
        <div class="input-wrapper">
          <div class="input-container">
            <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)" rows="1"></textarea>
          </div>
          <button id="sendBtn">å‘é€</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-mask" id="searchModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ğŸ” æœç´¢æ¶ˆæ¯</div>
        <div class="modal-close" data-close="searchModal">âœ•</div>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <input id="searchInput" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆæ”¯æŒæ­£åˆ™ï¼š/pattern/ï¼‰"/>
          <button id="searchGoBtn">æœç´¢</button>
        </div>
        <div class="modal-list" id="searchResultList"></div>
      </div>
    </div>
  </div>
  <div class="modal-mask" id="starModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">â­ æ”¶è—å¤¹</div>
        <div class="modal-close" data-close="starModal">âœ•</div>
      </div>
      <div class="modal-body">
        <div style="font-size:13px;opacity:.9;">åŒå‡»æ¶ˆæ¯å¤åˆ¶ï¼›ç‚¹å‡»â€œâ­æ”¶è—/ğŸ“Œç½®é¡¶â€åä¼šå‡ºç°åœ¨è¿™é‡Œã€‚</div>
        <div class="modal-list" id="starList"></div>
      </div>
    </div>
  </div>
  <div class="modal-mask" id="exportModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ğŸ“¤ å¯¼å‡ºå¯¹è¯</div>
        <div class="modal-close" data-close="exportModal">âœ•</div>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <select id="exportFormat">
            <option value="json">JSONï¼ˆç»“æ„åŒ–ï¼‰</option>
            <option value="md">Markdownï¼ˆå¯è¯»ï¼‰</option>
            <option value="txt">çº¯æ–‡æœ¬</option>
          </select>
          <button id="exportDownloadBtn">ä¸‹è½½</button>
        </div>
        <div style="font-size:12px;opacity:.8;line-height:1.6;margin-top:8px;">
          æç¤ºï¼šMarkdown é€‚åˆå‘ç»™åˆ«äººæˆ–å­˜æ¡£ï¼›JSON é€‚åˆäºŒæ¬¡å¤„ç†ã€‚
        </div>
      </div>
    </div>
  </div>
  <div class="modal-mask" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
        <div class="modal-close" data-close="settingsModal">âœ•</div>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <select id="themeSelect">
            <option value="dark">æ·±é‚ƒè“ï¼ˆdarkï¼‰</option>
            <option value="light">æ¸…æ–°ç™½ï¼ˆlightï¼‰</option>
            <option value="purple">æ¢¦å¹»ç´«ï¼ˆpurpleï¼‰</option>
          </select>
          <button id="saveSettingsBtn">ä¿å­˜</button>
        </div>
        <div class="modal-row">
          <label style="min-width:110px;">åˆ›é€ æ€§</label>
          <input id="temperature" type="range" min="0" max="1" step="0.1" value="0.7"/>
          <span class="tag" id="temperatureValue">0.7</span>
        </div>
        <div class="modal-row">
          <label style="min-width:110px;">æœ€å¤§é•¿åº¦</label>
          <input id="maxTokens" type="range" min="500" max="4000" step="100" value="2000"/>
          <span class="tag" id="maxTokensValue">2000</span>
        </div>
        <div class="modal-row">
          <label style="min-width:110px;">æ‰“å­—é€Ÿåº¦</label>
          <input id="typingSpeed" type="range" min="10" max="100" step="5" value="30"/>
          <span class="tag" id="typingSpeedValue">30ms</span>
        </div>
        <div style="margin-top:12px;font-size:12px;opacity:.85;line-height:1.6;">
          æ–°å¢ï¼š<span class="mono">/mask on|off</span> å¯é®ç½©æ‰‹æœºå·/é‚®ç®±/èº«ä»½è¯æ ·å¼å­—ç¬¦ä¸²ï¼›<span class="mono">/faq</span> æŸ¥çœ‹å†…ç½®FAQã€‚
        </div>
      </div>
    </div>
  </div>
  <div class="notification" id="notification"></div>
  <script>
const CONFIG = {
  API_KEY: 'f24dd041108b47cfab307fb42d2dea2d.rdCpvxs0JPkx0fT4',
  API_URL: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
  MODEL: 'glm-4',
  DEFAULT_TEMPERATURE: 0.7,
  DEFAULT_MAX_TOKENS: 2000,
  CORRECT_KEY: 'abc123456',
  PRESET_ANSWER:
    'æˆ‘æ˜¯ã€æ˜Ÿæ¾œæ™ºèƒ½åŠ©æ‰‹ã€‘ï¼ˆæ˜Ÿæ¾œAIï¼‰ï¼Œä½ çš„è´´å¿ƒå°ç®¡å®¶ï¼Œå¯ä»¥å›ç­”ä½ çš„å„ç§é—®é¢˜ã€æä¾›å†™ä½œ/æ€»ç»“/æ–¹æ¡ˆ/ä»£ç å»ºè®®ç­‰å¸®åŠ©ã€‚'
};
let conversationHistory = [];
let currentUser = null;
let starredMessages = [];
let isProcessing = false;
let settings = {
  theme: 'dark',
  temperature: CONFIG.DEFAULT_TEMPERATURE,
  maxTokens: CONFIG.DEFAULT_MAX_TOKENS,
  typingSpeed: 30,
  showTimestamp: true,
  enableSound: true,
  autoScroll: true,
  fontSize: 14,
  enableParticles: true,
  enableScanLine: true,
  enableTypingEffect: true,
  performanceMode: 'balanced',
  maskSensitive: false
};
const loginContainer = document.getElementById('loginContainer');
const appContainer   = document.getElementById('appContainer');
const loginForm      = document.getElementById('loginForm');
const chatArea       = document.getElementById('chatArea');
const welcomeScreen  = document.getElementById('welcomeScreen');
const messageInput   = document.getElementById('messageInput');
const sendBtn        = document.getElementById('sendBtn');
const newChatBtn     = document.getElementById('newChatBtn');
const clearBtn       = document.getElementById('clearBtn');
const logoutBtn      = document.getElementById('logoutBtn'); // æ–°å¢
const userName       = document.getElementById('userName');
const exportBtn = document.getElementById('exportBtn');
const maskBtn   = document.getElementById('maskBtn');
const searchModal   = document.getElementById('searchModal');
const starModal     = document.getElementById('starModal');
const exportModal   = document.getElementById('exportModal');
const settingsModal = document.getElementById('settingsModal');
const openSearchBtn  = document.getElementById('openSearchBtn');
const openStarredBtn = document.getElementById('openStarredBtn');
const themeSelect      = document.getElementById('themeSelect');
const temperatureRange = document.getElementById('temperature');
const maxTokensRange   = document.getElementById('maxTokens');
const typingSpeedRange = document.getElementById('typingSpeed');
const temperatureValue = document.getElementById('temperatureValue');
const maxTokensValue   = document.getElementById('maxTokensValue');
const typingSpeedValue = document.getElementById('typingSpeedValue');

// åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–è®¾ç½®
function optimizePerformance() {
  // å‡å°‘é‡ç»˜å’Œå›æµ
  chatArea.style.contain = 'strict';
  
  // ç¦ç”¨ä¸å¿…è¦çš„åŠ¨ç”»ä»¥æé«˜å“åº”é€Ÿåº¦
  if (settings.performanceMode === 'high') {
    document.documentElement.style.setProperty('--animate-duration', '0.1s');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  optimizePerformance();
  initParticles();
  initEventListeners();
  loadSettings();
  initExtraModules();
  
  // é¢„åŠ è½½å¯èƒ½éœ€è¦çš„èµ„æº
  preloadResources();
});

// é¢„åŠ è½½èµ„æº
function preloadResources() {
  // å¯ä»¥åœ¨è¿™é‡Œé¢„åŠ è½½ä»»ä½•å¯èƒ½éœ€è¦çš„èµ„æº
}

function initParticles(){
  if (!settings.enableParticles) return;
  
  const particlesContainer = document.getElementById('particles');
  particlesContainer.innerHTML = '';
  
  // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–ç²’å­åˆ›å»º
  let count = 0;
  const totalParticles = 30;
  
  function createParticle() {
    if (count >= totalParticles) return;
    
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.width = (Math.random() * 5 + 2) + 'px';
    p.style.height = p.style.width;
    p.style.left = (Math.random() * 100) + '%';
    p.style.animationDelay = (Math.random() * 15) + 's';
    p.style.animationDuration = (Math.random() * 10 + 10) + 's';
    particlesContainer.appendChild(p);
    
    count++;
    requestAnimationFrame(createParticle);
  }
  
  requestAnimationFrame(createParticle);
}

function initEventListeners(){
  loginForm.addEventListener('submit', handleLogin);
  sendBtn.addEventListener('click', sendMessage);
  
  // ä¿®æ”¹ä¸ºEnterå‘é€ï¼ŒShift+Enteræ¢è¡Œ
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  messageInput.addEventListener('input', () => {
    // ä¼˜åŒ–è¾“å…¥æ¡†é«˜åº¦è°ƒæ•´ï¼Œå‡å°‘å¸ƒå±€è®¡ç®—
    const currentHeight = messageInput.style.height;
    messageInput.style.height = 'auto';
    const newHeight = messageInput.scrollHeight + 'px';
    if (currentHeight !== newHeight) {
      messageInput.style.height = newHeight;
    }
  });
  
  newChatBtn.addEventListener('click', newConversation);
  clearBtn.addEventListener('click', () => {
    if(confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) newConversation();
  });
  
  // æ–°å¢ï¼šé€€å‡ºç™»å½•äº‹ä»¶ç›‘å¬
  logoutBtn.addEventListener('click', handleLogout);
  
  document.querySelectorAll('.quick-prompt').forEach(p => {
    p.addEventListener('click', () => {
      messageInput.value = p.textContent;
      messageInput.focus();
    });
  });
  
  openSearchBtn.addEventListener('click', () => openModal(searchModal));
  openStarredBtn.addEventListener('click', () => openModal(starModal));
  exportBtn.addEventListener('click', () => openModal(exportModal));
  
  maskBtn.addEventListener('click', () => {
    settings.maskSensitive = !settings.maskSensitive;
    showNotification(settings.maskSensitive ? 'å·²å¼€å¯æ•æ„Ÿä¿¡æ¯é®ç½©' : 'å·²å…³é—­æ•æ„Ÿä¿¡æ¯é®ç½©', 'success');
    saveSettings();
  });
  
  document.getElementById('settingsBtn').addEventListener('click', () => openModal(settingsModal));
  document.getElementById('saveSettingsBtn').addEventListener('click', () => {
    saveSettings();
    showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
    closeModal(settingsModal);
  });
  
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-close');
      closeModal(document.getElementById(id));
    });
  });
  
  document.getElementById('searchGoBtn').addEventListener('click', () => searchMessages());
  document.getElementById('exportDownloadBtn').addEventListener('click', () => exportConversation());
  
  themeSelect.addEventListener('change', (e)=>switchTheme(e.target.value));
  temperatureRange.addEventListener('input', (e)=>{
    settings.temperature=parseFloat(e.target.value);
    temperatureValue.textContent=e.target.value;
  });
  maxTokensRange.addEventListener('input', (e)=>{
    settings.maxTokens=parseInt(e.target.value);
    maxTokensValue.textContent=e.target.value;
  });
  typingSpeedRange.addEventListener('input', (e)=>{
    settings.typingSpeed=parseInt(e.target.value);
    typingSpeedValue.textContent=e.target.value + 'ms';
  });
}

function handleLogin(e) {
  e.preventDefault();
  const accessKey = document.getElementById('accessKey').value;
  
  if (accessKey === CONFIG.CORRECT_KEY) {
    currentUser = { name: 'ç”¨æˆ·', avatar: 'ğŸ‘¤' };
    userName.textContent = 'å·²è®¤è¯ç”¨æˆ·';
    
    // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–ç™»å½•è¿‡æ¸¡åŠ¨ç”»
    requestAnimationFrame(() => {
      loginContainer.style.opacity = '0';
      loginContainer.style.transition = 'opacity 0.3s ease-out';
      
      setTimeout(() => {
        loginContainer.style.display = 'none';
        appContainer.classList.add('active');
        showNotification('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ä½¿ç”¨æ˜Ÿæ¾œæ™ºèƒ½åŠ©æ‰‹', 'success');
      }, 300);
    });
  } else {
    showNotification('å¯†é’¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
  }
}

// æ–°å¢ï¼šå¤„ç†é€€å‡ºç™»å½•
function handleLogout() {
  // ç¡®è®¤æç¤ºï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦æ›´å¹³æ»‘ä½“éªŒå¯å»æ‰ï¼‰
  if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
    // éšè—åº”ç”¨ç•Œé¢
    appContainer.classList.remove('active');
    
    // æ˜¾ç¤ºç™»å½•ç•Œé¢
    loginContainer.style.display = 'flex';
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ display: flex ç”Ÿæ•ˆåå†æ”¹å˜ opacityï¼Œå®ç°æ¸å…¥æ•ˆæœ
    requestAnimationFrame(() => {
      loginContainer.style.opacity = '1';
    });
    
    // é‡ç½®çŠ¶æ€
    currentUser = null;
    isProcessing = false;
    
    // æ¸…ç©ºå¯†é’¥è¾“å…¥æ¡†ï¼ˆå®‰å…¨èµ·è§ï¼‰
    document.getElementById('accessKey').value = '';
    
    // é‡ç½®å¯¹è¯çŠ¶æ€ï¼ˆå¯é€‰ï¼Œçœ‹éœ€æ±‚ï¼Œä¸€èˆ¬é€€å‡ºä¼šæ¸…ç©ºå½“å‰ä¼šè¯ï¼‰
    newConversation();
    
    showNotification('å·²é€€å‡ºç™»å½•', 'success');
  }
}

function sendMessage() {
  const message = messageInput.value.trim();
  if (!message || isProcessing) return;
  
  // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†ï¼Œæå‡å“åº”æ„Ÿ
  messageInput.value = '';
  messageInput.style.height = 'auto';
  
  if (welcomeScreen) {
    welcomeScreen.remove();
  }
  
  const maskedMessage = settings.maskSensitive ? maskSensitiveInfo(message) : message;
  addMessage('user', currentUser ? currentUser.name : 'ç”¨æˆ·', maskedMessage);
  
  conversationHistory.push({
    role: 'user',
    content: message,
    timestamp: new Date().toISOString()
  });
  
  // å‘½ä»¤å¤„ç†ä¼˜å…ˆï¼Œé¿å…APIè°ƒç”¨å»¶è¿Ÿ
  if (message.startsWith('/')) {
    handleCommand(message);
    return;
  }
  
  // ç«‹å³æ›´æ–°UIçŠ¶æ€
  isProcessing = true;
  sendBtn.disabled = true;
  document.getElementById('aiReadyText').textContent = 'æ˜Ÿæ¾œAI æ­£åœ¨æ€è€ƒ...';
  
  // ä½¿ç”¨setTimeoutå°†APIè°ƒç”¨æ”¾å…¥ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œé¿å…é˜»å¡UI
  setTimeout(() => {
    callAI(message).then(aiResponse => {
      const maskedResponse = settings.maskSensitive ? maskSensitiveInfo(aiResponse) : aiResponse;
      addMessageWithTyping('ai', 'æ˜Ÿæ¾œAI', maskedResponse, () => {
        conversationHistory.push({
          role: 'assistant',
          content: aiResponse,
          timestamp: new Date().toISOString()
        });
        isProcessing = false;
        sendBtn.disabled = false;
        document.getElementById('aiReadyText').textContent = 'æ˜Ÿæ¾œAI å·²å°±ç»ª';
      });
    }).catch(error => {
      addMessageWithTyping('error', 'æ˜Ÿæ¾œAI', 'æœåŠ¡é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚', () => {
        isProcessing = false;
        sendBtn.disabled = false;
        document.getElementById('aiReadyText').textContent = 'æ˜Ÿæ¾œAI å·²å°±ç»ª';
      });
    });
  }, 0);
}

// ä¼˜åŒ–APIè°ƒç”¨å‡½æ•°
function callAI(userMessage) {
  return new Promise((resolve, reject) => {
    const messageHistory = conversationHistory.map(m => ({
      role: m.role === 'user' ? 'user' : 'assistant',
      content: m.content
    }));
    messageHistory.push({ role: "user", content: userMessage });
    
    // ä½¿ç”¨AbortControllerå¤„ç†è¶…æ—¶å’Œå–æ¶ˆ
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
    
    fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.API_KEY}`
      },
      body: JSON.stringify({
        model: CONFIG.MODEL,
        messages: messageHistory,
        temperature: settings.temperature,
        max_tokens: settings.maxTokens
      }),
      signal: controller.signal
    })
    .then(response => {
      clearTimeout(timeoutId);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
      return response.json();
    })
    .then(data => {
      if (data.choices && data.choices.length > 0) {
        resolve(data.choices[0].message.content);
      } else {
        resolve(CONFIG.PRESET_ANSWER);
      }
    })
    .catch(error => {
      clearTimeout(timeoutId);
      console.error('APIè°ƒç”¨é”™è¯¯:', error);
      reject(error);
    });
  });
}

// æ·»åŠ æ¶ˆæ¯æ—¶ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMæ“ä½œ
function addMessage(role, sender, content) {
  const fragment = document.createDocumentFragment();
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;
  
  const now = new Date();
  const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  messageDiv.innerHTML = `
    <div class="message-avatar">${role === 'user' ? 'ğŸ‘¤' : role === 'ai' ? 'ğŸ¤–' : 'âš ï¸'}</div>
    <div class="message-content-wrapper">
      <div class="message-header">
        <div class="message-sender">${sender}</div>
        <div class="message-time">${timeString}</div>
      </div>
      <div class="message-content">${content}</div>
      <div class="msg-actions">
        <div class="msg-btn" onclick="copyMessage(this)">å¤åˆ¶</div>
        <div class="msg-btn" onclick="starMessage(this)">â­æ”¶è—</div>
      </div>
    </div>
  `;
  
  fragment.appendChild(messageDiv);
  chatArea.appendChild(fragment);
  
  // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
  if (settings.autoScroll) {
    requestAnimationFrame(() => {
      chatArea.scrollTop = chatArea.scrollHeight;
    });
  }
}

// æ‰“å­—æ•ˆæœä¼˜åŒ–
function addMessageWithTyping(role, sender, content, callback) {
  const fragment = document.createDocumentFragment();
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;
  
  const now = new Date();
  const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  messageDiv.innerHTML = `
    <div class="message-avatar">${role === 'user' ? 'ğŸ‘¤' : role === 'ai' ? 'ğŸ¤–' : 'âš ï¸'}</div>
    <div class="message-content-wrapper">
      <div class="message-header">
        <div class="message-sender">${sender}</div>
        <div class="message-time">${timeString}</div>
      </div>
      <div class="message-content"></div>
      <div class="msg-actions">
        <div class="msg-btn" onclick="copyMessage(this)">å¤åˆ¶</div>
        <div class="msg-btn" onclick="starMessage(this)">â­æ”¶è—</div>
      </div>
    </div>
  `;
  
  fragment.appendChild(messageDiv);
  chatArea.appendChild(fragment);
  
  const contentDiv = messageDiv.querySelector('.message-content');
  let index = 0;
  
  // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ‰“å­—åŠ¨ç”»
  function typeChar() {
    if (index < content.length) {
      contentDiv.textContent += content.charAt(index);
      index++;
      
      // è‡ªåŠ¨æ»šåŠ¨ä¼˜åŒ–
      if (settings.autoScroll) {
        chatArea.scrollTop = chatArea.scrollHeight;
      }
      
      // æ ¹æ®å­—ç¬¦è°ƒæ•´å»¶è¿Ÿï¼Œæå‡æ‰“å­—ä½“éªŒ
      const delay = content.charAt(index) === '\n' ? settings.typingSpeed * 5 : settings.typingSpeed;
      setTimeout(() => requestAnimationFrame(typeChar), delay);
    } else {
      if (callback) callback();
    }
  }
  
  requestAnimationFrame(typeChar);
}

// å…¶ä»–å¿…è¦å‡½æ•°å®ç°
function newConversation() {
  conversationHistory = [];
  chatArea.innerHTML = '';
  chatArea.appendChild(welcomeScreen);
  document.getElementById('conversationTitle').textContent = 'æ–°å¯¹è¯';
  document.getElementById('conversationTime').textContent = 'åˆšåˆš';
}

function showNotification(message, type = '') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification';
  if (type) notification.classList.add(type);
  
  notification.classList.add('show');
  
  // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–åŠ¨ç”»
  requestAnimationFrame(() => {
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  });
}

function openModal(modal) {
  modal.classList.add('show');
}

function closeModal(modal) {
  modal.classList.remove('show');
}

function switchTheme(theme) {
  document.body.className = '';
  if (theme) document.body.classList.add(`${theme}-theme`);
  settings.theme = theme;
}

function saveSettings() {
  try {
    localStorage.setItem('ai_chat_settings', JSON.stringify(settings));
  } catch (e) {
    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
  }
}

function loadSettings() {
  try {
    const saved = localStorage.getItem('ai_chat_settings');
    if (saved) {
      settings = JSON.parse(saved);
      themeSelect.value = settings.theme || 'dark';
      temperatureRange.value = settings.temperature || CONFIG.DEFAULT_TEMPERATURE;
      maxTokensRange.value = settings.maxTokens || CONFIG.DEFAULT_MAX_TOKENS;
      typingSpeedRange.value = settings.typingSpeed || 30;
      
      temperatureValue.textContent = settings.temperature;
      maxTokensValue.textContent = settings.maxTokens;
      typingSpeedValue.textContent = settings.typingSpeed + 'ms';
      
      switchTheme(settings.theme);
    }
  } catch (e) {
    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
  }
}

function maskSensitiveInfo(text) {
  // ç®€å•çš„æ•æ„Ÿä¿¡æ¯é®ç½©å®ç°
  let masked = text;
  
  // æ‰‹æœºå·é®ç½©
  masked = masked.replace(/1[3-9]\d{9}/g, '1xxxxxxxxx');
  
  // é‚®ç®±é®ç½©
  masked = masked.replace(/(\w+)(@\w+\.\w+)/g, (match, p1, p2) => {
    if (p1.length > 3) return p1.substring(0, 3) + '***' + p2;
    return p1 + '***' + p2;
  });
  
  // èº«ä»½è¯å·é®ç½©
  masked = masked.replace(/\d{17}[\dXx]/g, 'xxxxxxxxxxxxxxxxx');
  
  return masked;
}

function copyMessage(btn) {
  const content = btn.closest('.message-content-wrapper').querySelector('.message-content').textContent;
  navigator.clipboard.writeText(content).then(() => {
    const originalText = btn.textContent;
    btn.textContent = 'å·²å¤åˆ¶';
    setTimeout(() => {
      btn.textContent = originalText;
    }, 2000);
  });
}

function starMessage(btn) {
  const content = btn.closest('.message-content-wrapper').querySelector('.message-content').textContent;
  const isStarred = btn.textContent.includes('å·²æ”¶è—');
  
  if (isStarred) {
    starredMessages = starredMessages.filter(m => m !== content);
    btn.textContent = 'â­æ”¶è—';
  } else {
    starredMessages.push(content);
    btn.textContent = 'âœ“å·²æ”¶è—';
  }
}

function searchMessages() {
  const query = document.getElementById('searchInput').value.trim();
  const resultList = document.getElementById('searchResultList');
  resultList.innerHTML = '';
  
  if (!query) return;
  
  let results = [];
  
  // ç®€å•æœç´¢å®ç°
  conversationHistory.forEach((msg, index) => {
    if (msg.content.includes(query)) {
      results.push({
        index,
        ...msg
      });
    }
  });
  
  if (results.length === 0) {
    resultList.innerHTML = '<div style="padding:15px;text-align:center;">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
    return;
  }
  
  results.forEach(result => {
    const item = document.createElement('div');
    item.className = 'modal-item';
    item.innerHTML = `
      <div style="min-width:60px;">${result.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
      <div style="flex:1;word-break:break-all;">${result.content.substring(0, 100)}${result.content.length > 100 ? '...' : ''}</div>
    `;
    resultList.appendChild(item);
  });
}

function exportConversation() {
  const format = document.getElementById('exportFormat').value;
  let content = '';
  const fileName = `æ˜Ÿæ¾œAIå¯¹è¯_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
  
  switch (format) {
    case 'json':
      content = JSON.stringify(conversationHistory, null, 2);
      downloadFile(fileName + '.json', content, 'application/json');
      break;
    case 'md':
      content = '# æ˜Ÿæ¾œAIå¯¹è¯è®°å½•\n\n';
      conversationHistory.forEach(msg => {
        content += `## ${msg.role === 'user' ? 'ç”¨æˆ·' : 'æ˜Ÿæ¾œAI'}\n`;
        content += `${msg.content}\n\n`;
      });
      downloadFile(fileName + '.md', content, 'text/markdown');
      break;
    case 'txt':
      content = 'æ˜Ÿæ¾œAIå¯¹è¯è®°å½•\n';
      content += '==================\n\n';
      conversationHistory.forEach(msg => {
        content += `${msg.role === 'user' ? 'ç”¨æˆ·' : 'æ˜Ÿæ¾œAI'}: ${msg.content}\n\n`;
      });
      downloadFile(fileName + '.txt', content, 'text/plain');
      break;
  }
  
  closeModal(exportModal);
}

function downloadFile(filename, content, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  
  // æ¸…ç†
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 0);
}

function handleCommand(command) {
  let response = '';
  
  switch (command.toLowerCase()) {
    case '/help':
      response = `å¯ç”¨å‘½ä»¤ï¼š
- /helpï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- /faqï¼šæ˜¾ç¤ºå¸¸è§é—®é¢˜
- /mask on|offï¼šå¼€å¯/å…³é—­æ•æ„Ÿä¿¡æ¯é®ç½©
- /clearï¼šæ¸…ç©ºå½“å‰å¯¹è¯
- /theme ä¸»é¢˜åï¼šåˆ‡æ¢ä¸»é¢˜ï¼ˆdark/light/purpleï¼‰`;
      break;
    case '/faq':
      response = `å¸¸è§é—®é¢˜ï¼š
1. å¦‚ä½•å¯¼å‡ºå¯¹è¯ï¼Ÿç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„ğŸ“¤å›¾æ ‡
2. å¦‚ä½•æ”¶è—æ¶ˆæ¯ï¼Ÿæ¯æ¡æ¶ˆæ¯ä¸‹æ–¹æœ‰ç‚¹â­æ”¶è—æŒ‰é’®
3. å¦‚ä½•åˆ‡æ¢ä¸»é¢˜ï¼Ÿç‚¹å‡»âš™ï¸è®¾ç½®æŒ‰é’®é€‰æ‹©ä¸»é¢˜
4. å¦‚ä½•é®ç½©æ•æ„Ÿä¿¡æ¯ï¼Ÿç‚¹å‡»ğŸ•¶ï¸å›¾æ ‡æˆ–ä½¿ç”¨/maskå‘½ä»¤`;
      break;
    case '/clear':
      newConversation();
      return;
    default:
      if (command.startsWith('/mask')) {
        const parts = command.split(' ');
        if (parts.length > 1) {
          settings.maskSensitive = parts[1].toLowerCase() === 'on';
          saveSettings();
          response = settings.maskSensitive ? 'å·²å¼€å¯æ•æ„Ÿä¿¡æ¯é®ç½©' : 'å·²å…³é—­æ•æ„Ÿä¿¡æ¯é®ç½©';
        } else {
          response = `å½“å‰æ•æ„Ÿä¿¡æ¯é®ç½©ï¼š${settings.maskSensitive ? 'å¼€å¯' : 'å…³é—­'}\nä½¿ç”¨/mask on|offåˆ‡æ¢`;
        }
      } else if (command.startsWith('/theme')) {
        const parts = command.split(' ');
        if (parts.length > 1 && ['dark', 'light', 'purple'].includes(parts[1])) {
          switchTheme(parts[1]);
          saveSettings();
          response = `å·²åˆ‡æ¢åˆ°${parts[1]}ä¸»é¢˜`;
        } else {
          response = `å½“å‰ä¸»é¢˜ï¼š${settings.theme}\nå¯ç”¨ä¸»é¢˜ï¼šdark, light, purple\nä½¿ç”¨/theme ä¸»é¢˜ååˆ‡æ¢`;
        }
      } else {
        response = `æœªçŸ¥å‘½ä»¤ï¼š${command}\nè¾“å…¥/helpæŸ¥çœ‹å¯ç”¨å‘½ä»¤`;
      }
  }
  
  const maskedResponse = settings.maskSensitive ? maskSensitiveInfo(response) : response;
  addMessageWithTyping('ai', 'æ˜Ÿæ¾œAI', maskedResponse, () => {
    conversationHistory.push({
      role: 'assistant',
      content: response,
      timestamp: new Date().toISOString()
    });
    isProcessing = false;
    sendBtn.disabled = false;
  });
}

function initExtraModules() {
  // å¯ä»¥åˆå§‹åŒ–å…¶ä»–é¢å¤–æ¨¡å—
}
  </script>
</body>
</html>
